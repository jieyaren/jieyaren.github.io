---
layout: post
title: anna 解读
category: tools
tags: [todo]
---
{% include JB/setup %}


这个鸽了很久


核心点

常识
存储任意规模的数据，必须以range或hash方式对数据进行分区，而且hash更通用一些

anna的特点

用 actor来管理数据分片，而不是共享的 我记得riak也是这么搞的，并且实现了CRDT

基于格理论能够优雅地实现无协调一致性模型，代码不仅精简而且更加模块化？？？

其无协调一致性模型的理论基础主要来自于HATs，格理论主要来自于Bloom-L？？？没读过

# 设计原则
- 多主复制消除热点
    - 在任意数据访问分布下没有读热点，必须支持多副本，负载均衡热点key的访问
    - 在任意数据访问分布下没有写热点，必须支持多个主副本，负载均衡热点key的更新

**这几条不就更riak了？**

# 核心设计点

### 多线程模型

现今的大多数KVS系统在单机多核硬件架构下都是基于共享内存架构（包括SEDA）实现的：
- 操作系统调度多个线程，线程数远大于CPU核数
- 多线程并发访问共享的数据存储内存结构
- 通过锁或无锁技术控制并发访问

随着单机核数的增加，共享内存架构下的CPU缓存一致性同步开销已经成为多核机器性能扩展的瓶颈，即便是无锁算法也无法从根本上解决问题，于是业内提出了异步消息通知架构：
- 一个线程绑定一个CPU核，避免线程切换、L1 cache miss
- 每个CPU线程运行一个event loop从输入队列中响应用户及其它CPU线程发来的请求
- 每个线程访问自己的私有内存结构，避免内核/用户态锁切换、CPU缓存一致性开销
- 线程与线程之间通过消息队列异步非阻塞通信，避免同步阻塞开销

Anna必须采用异步消息通知架构才能满足单机性能极致的需求

**seastar 相比呢？同样是actor**


### 副本策略及数据版本冲突管理

现代的分布式存储系统都会采用多副本策略，一方面可以提供数据的可靠性、可用性；另一方面可以将读热点负载均衡，提高系统的读吞吐性能。但是对于写操作会有如下两种处理策略：

单主副本

每个KV根据key路由到一个确定的CPU线程处理，通过paxos、raft、zab等算法保证副本一致性。在提 供数据强一致的同时，也限制了单KV更新吞吐量的理论上限

多主副本

每个KV根据key路由到任意一个负责该KV副本的CPU线程处理，单KV更新吞吐量的性能上限随着副本 系数的增长而增长，但系统只能保证数据的最终一致

Anna追求的是无协调的极致性能及扩展性，必须避免读热点和写热点，每个副本可读、可写才能满足需求。但这样做，需要解决多主副本的一致性，有如下两种策略

# ref
- https://cloud.tencent.com/developer/news/196252
